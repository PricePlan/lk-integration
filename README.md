# Интеграция интерфейса личного кабинета PricePlan с личным кабинетом стороннего веб сервиса

![](/assets/lk_123-1600x400.png)

В экосистеме PricePlan существует модуль личного кабинета (ЛК), который может
  использоваться, как «из коробки» (для этого ваши клиенты должны заходить в
  кабинет клиента по URL вида https://*yoursubdomain*-lk.priceplan.pro/).

Данное решение подходит не для всех наших партнёров. Как показывает практика,
  подавляющие большинство из них выбирают способ интеграции посредством
  [iframe](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe).

**Обратите внимание**: для того, чтобы означенный функционал стал доступен
  клиентам (по умолчанию он отключен), необходимо подключить его в настройках
  биллинга (Интеграции &#8594; Кабинет клиента).

![](/assets/PA-integration-01.png)

## Встраивание через *iframe*

Приступая к интеграции, необходимо ясно осознать механизм сетевого
  взаимодействия между броузером пользователя, порталом клиента и ЛК PricePlan.

Актуальный сценарий включает следующие этапы:

1. После авторизации в вашем личном кабинете любым способом, например,
  с помощью логина и пароля, валидными для вашего web-приложения, броузер пользователя осуществляет переход тем или иным способом на вашу страницу
  кабинета клиента.

2. На данной (родительской) странице должен присутствовать HTML-элемент
  *iframe* для отображения ЛК PricePlan. В качестве атрибута *src* у этого
  элемента следует указать URL ресурса на вашем бэкенде, который решает
  3 задачи:

  2.1. Получает через API PricePlan *токен* для аутентификации данного
    пользователя. При этом аргументом запроса методом GET выступает
    **идентификатор пользователя** клиента PricePlan
    (https://*yoursubdomain*-lk.priceplan.pro/api/users/*USER_ID*/reset_token/);

  2.2. Конструирует ссылку вида
    https://*yoursubdomain*-lk.priceplan.pro/auth-key/*token*/

  2.3. Возвращает броузеру ответ с перенаправлением на URL полученной ссылки

3. В результате *iframe* будет заполнен соответствующим содержимым дочерней
  страницы.

## Реализация

Для того, чтобы описанный сценарий заработал необходимо выполнить, как минимум,
  первые 3 пункта из описанных далее.

### 1. Хранение ID пользователя PricePlan на стороне клиента

Для того, чтобы предотвратить отправку избыточных запросов к API, целесообразно
  обеспечить долговременное хранение идентификатора пользователя клиента
  PricePlan в профиле клиента на вашей стороне.

Получить USER_ID для набора клиентов можно серией запросов, подобных этому:

```bash
curl -X GET \
    -u '<service_user_api_key>:<service_user_password>' \
    -H 'Content-Type: application/json; charset=utf-8' \
    "https://<yoursubdomain>.priceplan.pro/api/clients/?take=25&skip=0&"`
      `"page=1&pageSize=25&filter%5Blogic%5D=and&"`
      `"fields=client__account_number%2Cclient__name%2Cclient__id%2C"`
      `"client__delete%2Cclient__user_id"
```

### 2. Ресурс на сайте клиента для авторизации пользователя в ЛК PricePlan

Чтобы пользователь мог быть авторизован в ЛК PricePlan по ссылке, требуется
  реализовать специальный ресурс. Логика его работы описана в п.2 сценария.
  Отметим также, что перед отправкой запросов к API PricePlan следует начать
  авторизованную web-сессию с логином и паролем предварительного созданного
  служебного пользователя с ролью «Менеджер».

##### Пример реализации на Python

Пожалуйста, см. специально созданный демонстрационный пример
  [customer-cabinet-example](https://github.com/linskiy/customer-cabinet-example).

### 3. Добавление скриптов в код страницы

Результирующий HTML код на странице клиента должен содержать примерно такой
  фрагмент:

```html
<iframe id="pp" src="{{ iframe_src }}" width="100%">
  PricePlan will be shown here.
</iframe>

<!-- И далее -->

<script src="{{ prefix }}/js/iframeResizer.min.js"></script>
<script>
  iFrameResize({
    log: false,
    warningTimeout: 15000,
    checkOrigin: false
  });
</script>
```

### 4. Предотвращение выхода пользователя из ЛК PricePlan

Чтобы пользователь кабинета случайно или преднамеренно не прервал
  авторизованную web-сессию с сервером PricePlan, достаточно скрыть кнопку
  «Выход», обычно расположенную вверху справа страницы. Для этого нужно в
  настройках модуля ЛК Priceplan в поле «Добавление CSS» вставить следующий
  фрагмент кода:

```css
#logout_from_cabimet {
  display: none;
}
```